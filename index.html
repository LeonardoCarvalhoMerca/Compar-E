<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compar-E</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700&family=Roboto:wght@400&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-cyan: #00ffff;
            --neon-pink: #0004ff;
            --dark-bg: #0b021d; 
            --container-bg: #110729;
            --text-light: #f0f0f0;
            --text-dim: #aaaaaa;
            --neon-green: #39FF14;
            --neon-red: #FF3131;
        }

        html {
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        body {
            font-family: "Roboto", sans-serif;
            line-height: 1.6;
            color: var(--text-dim);
            background-color: var(--dark-bg); 
            background-image: url("https://unblast.com/wp-content/uploads/2021/01/Space-Background-Image-3-1536x1024.jpg"); 
            background-size: cover;
            background-position: center; 
            background-attachment: fixed;
            background-blend-mode: overlay; 
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: rgba(17, 7, 41, 0.9);
            padding: 30px;
            border-radius: 8px;
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4), 
                        0 0 25px rgba(0, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        h1 {
            font-family: "Exo 2", sans-serif;
            color: var(--neon-cyan);
            text-align: center;
            text-shadow: 0 0 5px var(--neon-cyan), 
                         0 0 10px rgba(0, 255, 255, 0.7);
        }
        
        .upload-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        .upload-box {
            padding: 15px;
            border: 2px dashed var(--neon-cyan);
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s ease;
            background-color: rgba(0, 255, 255, 0.05);
        }
        .upload-box:hover {
             background-color: rgba(0, 255, 255, 0.1);
        }
        .upload-box label {
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
            color: var(--neon-cyan);
            text-shadow: 0 0 3px var(--neon-cyan);
        }
        
        input[type="file"] {
            font-size: 0.9em;
            color: var(--text-dim);
            font-family: "Roboto", sans-serif;
        }
        input[type="file"]::file-selector-button {
            font-family: "Roboto", sans-serif;
            font-weight: bold;
            color: var(--neon-cyan);
            background-color: transparent;
            border: 1px solid var(--neon-cyan);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: var(--neon-cyan);
            color: var(--dark-bg);
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        button {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-light);
            text-shadow: 0 0 5px var(--text-light);
            background-color: var(--neon-pink);
            border: 1px solid var(--neon-pink);
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-pink), 
                        0 0 20px rgba(255, 0, 255, 0.5);
            transition: all 0.3s ease;
        }
        button:hover {
            box-shadow: 0 0 20px var(--neon-pink), 
                        0 0 40px rgba(255, 0, 255, 0.7);
            text-shadow: 0 0 10px var(--text-light);
        }
        button:disabled {
            background-color: #555;
            color: #888;
            border-color: #555;
            box-shadow: none;
            text-shadow: none;
            cursor: not-allowed;
        }

        #results {
            margin-top: 30px;
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-light);
            padding: 20px;
            border-radius: 5px;
            font-family: "Consolas", "Courier New", monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            border: 1px solid var(--neon-cyan);
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(2px);
            line-height: 1.5;
        }
        .loading {
            text-align: center;
            font-weight: bold;
            color: var(--neon-cyan);
        }
        
        .log-success {
            color: var(--neon-green);
            text-shadow: 0 0 3px var(--neon-green);
        }
        .log-error {
            color: var(--neon-red);
            text-shadow: 0 0 3px var(--neon-red);
        }
        .log-neutral {
            color: var(--text-light);
        }
        .log-header {
            color: var(--neon-cyan);
            font-weight: bold;
        }


        ::-webkit-scrollbar {
            width: 8px !important;
            height: 8px !important;
            background: transparent !important;
        }
        ::-webkit-scrollbar-thumb {
            border-radius: 8px !important;
            background-color: var(--neon-pink) !important;
            box-shadow: 0 0 5px var(--neon-pink);
        }
        ::-webkit-scrollbar-track {
            border-radius: 8px !important;
            background-color: var(--container-bg) !important;
            border: none !important;
        }
    </style>
    </head>
<body>

    <div class="container">
        <h1>compar-E</h1>
        <p>Faça o upload de duas planilhas (.xlsx ou .csv). A coluna <strong>valor_final</strong> (ou <strong>Faturamento</strong>) é obrigatória. A coluna <strong>id_cupom</strong> (ou <strong>Cupom</strong>) é opcional (permite a análise completa).</p>
        
        <div class="upload-area">
            <div class="upload-box">
                <label for="fileA">Planilha A</label>
                <input type="file" id="fileA" accept=".xlsx, .xls, .csv">
            </div>
            <div class="upload-box">
                <label for="fileB">Planilha B</label>
                <input type="file" id="fileB" accept=".xlsx, .xls, .csv">
            </div>
        </div>

        <button id="compareButton">Comparar Planilhas</button>

        <pre id="results" aria-live="polite"></pre>
    </div>

    <script>
        const fileAInput = document.getElementById('fileA');
        const fileBInput = document.getElementById('fileB');
        const compareButton = document.getElementById('compareButton');
        const resultsEl = document.getElementById('results');
        compareButton.addEventListener('click', handleCompare);

        async function handleCompare() {
            resultsEl.innerHTML = '<span class="log-neutral">Iniciando análise... ⏳</span>\n';
            compareButton.disabled = true;
            compareButton.textContent = 'Processando...';
            const fileA = fileAInput.files[0];
            const fileB = fileBInput.files[0];

            if (!fileA || !fileB) {
                log("Erro: Por favor, selecione as duas planilhas.", 'error');
                resetButton();
                return;
            }
            try {
                const [resultA, resultB] = await Promise.all([
                    readExcel(fileA),
                    readExcel(fileB)
                ]);

                const analysisMode = (resultA.hasIdCupom && resultB.hasIdCupom) ? 'full' : 'simple';
                analisarCupons(resultA.data, resultB.data, analysisMode);

            } catch (error) {
                log(`\n--- ERRO GERAL ---`, 'error');
                log(`Ocorreu um erro: ${error.message}`, 'error');
                console.error(error);
            } finally {
                resetButton();
            }
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = event.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        if (jsonData.length === 0) {
                            reject(new Error(`A planilha '${file.name}' está vazia.`));
                            return;
                        }

                        const firstRow = jsonData[0];

                        // 1. Encontra os nomes das colunas (prioriza os nomes originais)
                        // Procura por 'id_cupom' OU 'Cupom'
                        const idColName = firstRow.id_cupom !== undefined ? 'id_cupom' : 
                                          (firstRow.Cupom !== undefined ? 'Cupom' : null);
                        
                        const valColName = firstRow.valor_final !== undefined ? 'valor_final' : 
                                           (firstRow.Faturamento !== undefined ? 'Faturamento' : null);

                        if (!valColName) {
                            reject(new Error(`A planilha '${file.name}' não contém a coluna obrigatória 'valor_final' ou 'Faturamento'.`));
                            return;
                        }

                        const hasIdCupom = (idColName !== null);

                        let filteredData;
                        if (hasIdCupom) {
                            filteredData = jsonData.map(row => ({
                                id_cupom: String(row[idColName]).split(':')[0],
                                valor_final: row[valColName]                  
                            }));
                        } else {
                            filteredData = jsonData.map(row => ({
                                valor_final: row[valColName]                 
                            }));
                        }
                        
                        resolve({ data: filteredData, hasIdCupom: hasIdCupom });

                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsBinaryString(file);
            });
        }


        function analisarCupons(dataA, dataB, analysisMode) {
            resultsEl.innerHTML = ''; 
            log(`--- INICIANDO ANÁLISE ---`, 'header');

            const safeNum = (val) => {
                const num = parseFloat(val);
                return isNaN(num) ? 0 : num;
            };

            const getCancelFlag = (value) => {
                return safeNum(value) < 0 ? " [cancelamento de cupom]" : "";
            };

            if (analysisMode === 'full') {
                log(`[MODO DE ANÁLISE: Completa (ID + Valor)]`, 'header');

                log("\n[Procurando cupons duplicados]", 'header');
                const duplicadosA = findDuplicates(dataA, 'id_cupom');
                if (duplicadosA.length > 0) {
                    log(`(!) ATENÇÃO: ${duplicadosA.length} IDs duplicados na Planilha A: [${duplicadosA.join(', ')}]`, 'error');
                } else {
                    log("(+) Planilha A não possui IDs de cupom duplicados.", 'success');
                }
                
                const duplicadosB = findDuplicates(dataB, 'id_cupom');
                if (duplicadosB.length > 0) {
                    log(`(!) ATENÇÃO: ${duplicadosB.length} IDs duplicados na Planilha B: [${duplicadosB.join(', ')}]`, 'error');
                } else {
                    log("(+) Planilha B não possui IDs de cupom duplicados.", 'success');
                }

                const df_a_unicos = dropDuplicates(dataA, 'id_cupom');
                const df_b_unicos = dropDuplicates(dataB, 'id_cupom');

                log("\n[Verificando Cupons Exclusivos (não enviados/recebidos)]", 'header');
                const ids_a = new Set(df_a_unicos.map(item => item.id_cupom));
                const ids_b = new Set(df_b_unicos.map(item => item.id_cupom));
                const apenas_em_a = [...ids_a].filter(id => !ids_b.has(id));
                const apenas_em_b = [...ids_b].filter(id => !ids_a.has(id));
                const em_ambas = [...ids_a].filter(id => ids_b.has(id));
                
                const mapA = new Map(df_a_unicos.map(item => [item.id_cupom, item.valor_final]));
                const mapB = new Map(df_b_unicos.map(item => [item.id_cupom, item.valor_final]));

                if (apenas_em_a.length === 0) {
                    log("(+) Todos os cupons da Planilha A estão na Planilha B.", 'success');
                } else {
                    log(`(!) Cupons que existem APENAS na Planilha A (${apenas_em_a.length}): [${
                        apenas_em_a.map(id => `${id}${getCancelFlag(mapA.get(id))}`).join(', ')
                    }]`, 'error');
                }
                
                if (apenas_em_b.length === 0) {
                    log("(+) Todos os cupons da Planilha B estão na Planilha A.", 'success');
                } else {
                    log(`(!) Cupons que existem APENAS na Planilha B (${apenas_em_b.length}): [${
                        apenas_em_b.map(id => `${id}${getCancelFlag(mapB.get(id))}`).join(', ')
                    }]`, 'error');
                }


                log("\n[Verificando Divergências de Valor (em IDs comuns)]", 'header');
                
                const divergencias = [];
                if (em_ambas.length > 0) {
                    for (const id of em_ambas) {
                        const valorA = safeNum(mapA.get(id)); 
                        const valorB = safeNum(mapB.get(id));
                        const valorARound = Math.round(valorA * 100) / 100;
                        const valorBRound = Math.round(valorB * 100) / 100;
                        if (valorARound !== valorBRound) {
                            divergencias.push({
                                id_cupom: id,
                                valor_final_A: valorARound,
                                valor_final_B: valorBRound
                            });
                        }
                    }

                    if (divergencias.length === 0) {
                        log(`(+) SUCESSO! Todos os ${em_ambas.length} cupons em comum possuem o MESMO valor.`, 'success');
                    } else {
                        log(`(!) ATENÇÃO: ${divergencias.length} cupons em comum possuem valores DIFERENTES:`, 'error');
                        log("id_cupom | Valor A | Valor B");
                        divergencias.forEach(d => {
                            const flagA = getCancelFlag(d.valor_final_A);
                            const flagB = getCancelFlag(d.valor_final_B);
                            log(`${d.id_cupom} | ${d.valor_final_A.toFixed(2)}${flagA} | ${d.valor_final_B.toFixed(2)}${flagB}`, 'error');
                        });
                    }
                } else {
                    log("(-) Não há cupons em comum entre as planilhas para comparar valores.");
                }

                log("\n[Balanço Financeiro | Diferencial (A - B)]", 'header');
                const totalApenasEmA = apenas_em_a.reduce((sum, id) => {
                    return sum + safeNum(mapA.get(id));
                }, 0);
                log(`(+) Valor total APENAS em A: +${totalApenasEmA.toFixed(2)}`);

                const totalApenasEmB = apenas_em_b.reduce((sum, id) => {
                    return sum + safeNum(mapB.get(id));
                }, 0);
                log(`(-) Valor total APENAS em B: -${totalApenasEmB.toFixed(2)}`);

                const totalDivergenciasNet = divergencias.reduce((sum, d) => {
                    return sum + (d.valor_final_A - d.valor_final_B);
                }, 0);
                
                const statusDivergencia = totalDivergenciasNet === 0 ? 'success' : 'neutral'; // Neutral if 0, error if not
                log(`(+/-) Diferença líquida (A-B) de IDs comuns: ${totalDivergenciasNet.toFixed(2)}`, totalDivergenciasNet === 0 ? 'success' : 'neutral');
                
                const diferencaLiquidaTotal = totalApenasEmA - totalApenasEmB + totalDivergenciasNet;
                
                log("----------------------------------------");
                const statusReconciliacao = diferencaLiquidaTotal === 0 ? 'success' : 'error';
                log(`(=) DIFERENÇA LÍQUIDA (RECONCILIAÇÃO): ${diferencaLiquidaTotal.toFixed(2)}`, statusReconciliacao);
                if (diferencaLiquidaTotal !== 0) {
                     log(`    -> Há uma diferença de reconciliação de ${diferencaLiquidaTotal.toFixed(2)}.`, 'error');
                }


            } else {
                log("[MODO DE ANÁLISE: Simplificada (Apenas Valor)]", 'header');
                log("(id_cupom não encontrado em uma ou ambas as planilhas)");

                log("\n[Verificando Valores Exclusivos]", 'header');
                
                const round = (val) => Math.round(safeNum(val) * 100) / 100;
                const valoresA = new Set(dataA.map(item => round(item.valor_final)));
                const valoresB = new Set(dataB.map(item => round(item.valor_final)));

                const apenas_em_a = [...valoresA].filter(val => !valoresB.has(val));
                const apenas_em_b = [...valoresB].filter(val => !valoresA.has(val));

                if (apenas_em_a.length === 0) {
                    log("(+) Todos os valores da Planilha A também existem na Planilha B.", 'success');
                } else {
                    log(`(!) Valores que existem APENAS na Planilha A (${apenas_em_a.length}):\n[${
                        apenas_em_a.map(val => `${val}${getCancelFlag(val)}`).join(',\n ')
                    }]`, 'error');
                }
                
                if (apenas_em_b.length === 0) {
                    log("(+) Todos os valores da Planilha B também existem na Planilha A.", 'success');
                } else {
                    log(`(!) Valores que existem APENAS na Planilha B (${apenas_em_b.length}):\n[${
                        apenas_em_b.map(val => `${val}${getCancelFlag(val)}`).join(',\n ')
                    }]`, 'error');
                }
            }

            log("\n[Balanço Financeiro (Totais Gerais)]", 'header');

            const totalSomaA = dataA.reduce((sum, item) => {
                return sum + safeNum(item.valor_final);
            }, 0);
            const totalSomaB = dataB.reduce((sum, item) => {
                return sum + safeNum(item.valor_final);
            }, 0);

            const diferencaTotal = totalSomaA - totalSomaB;

            log(`Valor Total Planilha A: ${totalSomaA.toFixed(2)}`);
            log(`Valor Total Planilha B: ${totalSomaB.toFixed(2)}`);
            log("----------------------------------------");
            
            const statusTotal = diferencaTotal === 0 ? 'success' : 'error';
            log(`(=) Diferença Total (A - B): ${diferencaTotal.toFixed(2)}`, statusTotal);
            if (diferencaTotal > 0) {
                log(`    -> Planilha A tem ${diferencaTotal.toFixed(2)} a mais que B.`, 'error');
            } else if (diferencaTotal < 0) {
                log(`    -> Planilha B tem ${Math.abs(diferencaTotal).toFixed(2)} a mais que A.`, 'error');
            } else {
                log(`    -> Os totais brutos das planilhas são equivalentes.`, 'success');
            }

            log("\n--- ANÁLISE CONCLUÍDA ---", 'header');
        }


        function log(message, status = 'neutral') {
            let className = 'log-neutral';
            if (status === 'success') {
                className = 'log-success';
            } else if (status === 'error') {
                className = 'log-error';
            } else if (status === 'header') {
                className = 'log-header';
            }
            
            const span = document.createElement('span');
            span.className = className;
            span.textContent = message;
            
            resultsEl.appendChild(span);
            resultsEl.appendChild(document.createTextNode('\n'));
        }

        function resetButton() {
            compareButton.disabled = false;
            compareButton.textContent = 'Comparar Planilhas';
        }
        function findDuplicates(data, key) {
            const seen = new Set();
            const duplicates = new Set();
            data.forEach(item => {
                const value = item[key];
                if (seen.has(value)) {
                    duplicates.add(value);
                } else {
                    seen.add(value);
                }
            });
            return Array.from(duplicates);
        }
        function dropDuplicates(data, key) {
            const seen = new Set();
            const uniqueData = [];
            data.forEach(item => {
                const value = item[key];
                if (!seen.has(value)) {
                    seen.add(value);
                    uniqueData.push(item);
                }
            });
            return uniqueData;
        }
    </script>
</body>

</html>

